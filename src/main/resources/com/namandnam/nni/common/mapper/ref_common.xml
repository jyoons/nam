<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.namandnam.nni.common.mapper.CommonMapper">

	<!-- 권한 정보 -->
	 <select id="selectRolesList" resultType="Roles">
			SELECT IDX
				   , ROLES 
		      FROM TBL_ROLES tr
			 WHERE IDX != 0
	 </select>
	 

	<!-- 카테고리 리스트 -->
	<select id="selectOneFileInfo" parameterType="String" resultType="AttachFile">
	  		  SELECT TBL_IDX
	  		  		, TBL_CTGRY
	  		  		, FILE_TYPE
	  		  		, FILE_NAME
	  		  		, ORGNL_FILE_NAME
	  		  		, FILE_PATH
	  		  		, FILE_SIZE
	  		  		, FILE_SORT
	  		  		, FILE_DESC
	  		  		, REG_DT
				FROM reflexion_dev.TBL_FILE
			   WHERE IDX = #{fileIdx};
	 </select>
	 
	 
	 <insert id="insertIntoAttachFile" parameterType="AttachFile" >
		INSERT INTO reflexion_dev.TBL_FILE(
					TBL_CTGRY
					, TBL_IDX
					, FILE_TYPE
					, FILE_NAME
					, ORGNL_FILE_NAME
					, FILE_PATH
					, FILE_SIZE
					, FILE_SORT
					, FILE_DESC
					, REG_DT	)
		 VALUES(	
		 			#{tblCtgry}
		 			, #{tblIdx}
		 			, #{fileType}
		 			, #{fileName}
		 			, #{orgnlFileName}
		 			, #{filePath}
		 			, #{fileSize}
		 			, #{fileSort}
		 			, #{fileDesc}
		 			, now()
		 		)
	 </insert>
	 
	 
	 
	 <update id="updateIntoAttachFile" parameterType="AttachFile" >
		UPDATE reflexion_dev.TBL_FILE
		   SET TBL_CTGRY = #{tblCtgry}
		       , FILE_TYPE = #{fileType}
		       , File_NAME = #{fileName}
		       , ORGNL_FILE_NAME = #{orgnlFileName}
		       , FILE_PATH = #{filePath}
		       , FILE_SIZE = #{fileSize}
		       , FILE_SORT = #{fileSort}
		       , FILE_DESC = #{fileDesc}
		<where>
			AND TBL_IDX = #{tblIdx}
			<if test="tbCtgry != null and tbCtgry != '' ">
				AND TBL_CTGRY = #{tblCtgry}
			</if>
		</where>
	 </update>
	 
	 
	 
	<select id="selectOneByIdx" parameterType="String" resultType="AttachFile">
	  		  SELECT TBL_IDX
	  		  		, TBL_CTGRY
	  		  		, FILE_TYPE
	  		  		, FILE_NAME
	  		  		, ORGNL_FILE_NAME
	  		  		, FILE_PATH
	  		  		, FILE_SIZE
	  		  		, FILE_SORT
	  		  		, FILE_DESC
	  		  		, REG_DT
				FROM reflexion_dev.TBL_FILE
			   WHERE IDX = #{fileIdx};
	 </select>
	 
	 
	 
	 <delete id="deleteAttachFile" parameterType="String" >
		DELETE FROM reflexion_dev.TBL_FILE
		 WHERE IDX = #{fileIdx};
	 </delete>
	 
	 
	 
	
	
	
	
	
	
	<!-- 애래부터는 Sample Data 테스트용 -->
	
	<select id="selectOneSampleData" parameterType="String" resultType="SampleVo" >
		<![CDATA[ /* SQL_ID : selectOneSampleData */ ]]>
			SELECT TITLE
				 , CONTENTS
			  FROM reflexion_dev.TBL_SAMPLE
			 WHERE IDX = #{idx}
	</select>
	
	
	<insert id="insertIntoSampleData" parameterType="SampleVo" useGeneratedKeys="true"  keyProperty="idx">
		<![CDATA[ /* SQL_ID : insertIntoSampleData */ ]]>
		INSERT into TBL_SAMPLE(
			  	title, 
			  	contents
		) VALUES(
				#{title},
				#{contents}
		)
	</insert>
	
	
	
	 
	 
	 <select id="selectSampleList" parameterType="List" resultType="java.util.HashMap">
	 
  		  SELECT store,
  		  	 <foreach collection="list" item="i" separator="," index="index">
                   	max(col${index}) as col${i}
             </foreach>    
		  	FROM (
		         select  store,
		         
	         	 <foreach collection="list" item="i" separator="," index="index">
                    	count(case when REG_DATE = #{i} THEN 1 END) as col${index}
             	 </foreach>    
		          from ( select s.store 
		                       , date_format(c.reg, '%Y%m%d') as REG_DATE
		                from TBL_STORE s INNER JOIN TBL_COMPARE c ON s.idx = c.fk_store ) TB group by store, REG_DATE
		      ) TB2 group by store
	 </select>
	 
	  
</mapper>